name: Build Brady Auto Label Server

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        working-directory: ./print-server
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download SumatraPDF
        run: |
          $sumatraUrl = "https://www.sumatrapdfreader.org/dl/rel/3.5.2/SumatraPDF-3.5.2-64.zip"
          Invoke-WebRequest -Uri $sumatraUrl -OutFile sumatra.zip
          Expand-Archive -Path sumatra.zip -DestinationPath C:\sumatra

      - name: Verify Windows Print Logic
        working-directory: ./print-server
        run: |
          # Create a robust CI test script
          $testCode = @"
          import sys
          import os
          import subprocess
          from unittest.mock import patch, MagicMock

          def run_ci_test():
              print("--- Starting Windows CI Verification ---")
              
              # 1. Verify Imports
              print("Testing imports...")
              try:
                  import win32print
                  import reportlab
                  import qrcode
                  print("‚úÖ Dependencies loaded successfully")
              except ImportError as e:
                  print(f"‚ùå Failed to load dependencies: {e}")
                  sys.exit(1)

              # 2. Verify SumatraPDF exists and runs
              print("Testing SumatraPDF binary...")
              sumatra_path = r"C:\sumatra\SumatraPDF.exe"
              if os.path.exists(sumatra_path):
                  res = subprocess.run([sumatra_path, "-help"], capture_output=True)
                  print("‚úÖ SumatraPDF binary is executable")
              else:
                  print("‚ùå SumatraPDF not found at C:\sumatra")
                  sys.exit(1)

              # 3. Test PDF Generation
              print("Testing Label Generation...")
              from services import BradyLabelService, PrintService
              service = BradyLabelService("ci_temp")
              if not os.path.exists("ci_temp"): os.makedirs("ci_temp")
              
              pdf_path = service.generate_label("CI-TEST", "26", "02", "0001")
              if os.path.exists(pdf_path):
                  print(f"‚úÖ PDF generated at {pdf_path}")
              else:
                  print("‚ùå PDF generation failed")
                  sys.exit(1)

              # 4. Mock Printing Logic
              print("Testing Print Command Construction...")
              # We point the service to the CI path for Sumatra
              with patch('subprocess.run') as mock_run:
                  ps = PrintService()
                  # Mock system check and Sumatra path for development environment
                  # SumatraPDF.exe should be in the current working directory for the local dev logic in services.py
                  # We'll copy it there for the test
                  import shutil
                  shutil.copy(r"C:\sumatra\SumatraPDF.exe", "SumatraPDF.exe")
                  
                  ps.print_file(pdf_path, printer_name="DummyPrinter")
                  
                  # Check if subprocess was called with correct arguments
                  args = mock_run.call_args[0][0]
                  if "-print-to" in args and "DummyPrinter" in args and "-print-settings" in args:
                      print("‚úÖ Print command construction verified")
                  else:
                      print(f"‚ùå Invalid print command: {args}")
                      sys.exit(1)
              
              print("--- CI Verification Passed! ---")

          if __name__ == '__main__':
              run_ci_test()
          "@
          $testCode | Out-File -FilePath ci_verify.py -Encoding utf8
          python ci_verify.py

      - name: Build EXE (Folder Mode)

        working-directory: ./print-server
        run: |
          pyinstaller --onedir --name BradyAutoLabelServer `
            --collect-submodules reportlab `
            --add-binary "C:\sumatra\SumatraPDF.exe;bin/sumatra" `
            app.py


      - name: Create Zip Bundle
        working-directory: ./print-server/dist
        run: |
          Compress-Archive -Path BradyAutoLabelServer -DestinationPath BradyAutoLabelServer-Windows.zip

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BradyAutoLabelServer-Windows
          path: ./print-server/dist/BradyAutoLabelServer-Windows.zip

  create-release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: BradyAutoLabelServer-Windows
          path: ./artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Brady Auto Label Release v${{ github.run_number }}
          body: |
            Automated build for the Brady Auto Label Date System.
            
            ## Downloads
            
            | File | Description |
            |------|-------------|
            | **BradyAutoLabelServer-Windows.zip** | ü™ü **Download This** - Extract and run `BradyAutoLabelServer.exe` inside. No Python required. |
            
            ### How to run:
            1. Download and Extract the ZIP.
            2. Open the folder `BradyAutoLabelServer`.
            3. Double-click **`BradyAutoLabelServer.exe`**.
            4. Keep the window open to allow the frontend to communicate with your printers.
          files: |
            ./artifacts/*.zip
          draft: false
          prerelease: false
