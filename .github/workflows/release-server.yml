name: Build Brady Auto Label Server

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        working-directory: ./print-server
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Download SumatraPDF
        run: |
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\sumatra"
          $sumatraUrl = "https://www.sumatrapdfreader.org/dl/rel/3.5.2/SumatraPDF-3.5.2-64.zip"
          Invoke-WebRequest -Uri $sumatraUrl -OutFile sumatra.zip -ErrorAction Stop
          Expand-Archive -Path sumatra.zip -DestinationPath "${{ github.workspace }}\sumatra" -Force
          Write-Host "Listing Sumatra Directory:"
          Get-ChildItem -Path "${{ github.workspace }}\sumatra"

      - name: Verify Windows Print Logic
        working-directory: ./print-server
        run: |
          # Create a robust CI test script
          $sumatraPath = "${{ github.workspace }}\sumatra\SumatraPDF.exe"
          # Escape backslashes for Python string
          $pySumatraPath = $sumatraPath.Replace('\', '\\')
          
          $testCode = @"
          import sys
          import os
          import subprocess
          from unittest.mock import patch, MagicMock

          def run_ci_test():
              print("--- Starting Windows CI Verification ---")
              
              # 1. Verify Imports
              print("Testing imports...")
              try:
                  import win32print
                  import reportlab
                  import qrcode
                  print("[PASS] Dependencies loaded successfully")
              except ImportError as e:
                  print(f"[FAIL] Failed to load dependencies: {e}")
                  sys.exit(1)

              # 2. Verify SumatraPDF exists and runs
              print("Testing SumatraPDF binary...")
              sumatra_path = r"$pySumatraPath"
              # If the zip content was different, try to find ANY exe
              if not os.path.exists(sumatra_path):
                  base_dir = os.path.dirname(sumatra_path)
                  exes = [f for f in os.listdir(base_dir) if f.lower().endswith('.exe')]
                  if exes:
                      sumatra_path = os.path.join(base_dir, exes[0])
                      print(f"Note: Found Sumatra at alternative path: {sumatra_path}")

              if os.path.exists(sumatra_path):
                  res = subprocess.run([sumatra_path, "-help"], capture_output=True)
                  print("[PASS] SumatraPDF binary is executable")
              else:
                  print(f"[FAIL] SumatraPDF not found at {sumatra_path}")
                  sys.exit(1)

              # 3. Test PDF Generation
              print("Testing Label Generation...")
              from services import BradyLabelService, PrintService
              service = BradyLabelService("ci_temp")
              if not os.path.exists("ci_temp"): os.makedirs("ci_temp")
              
              pdf_path = service.generate_label("CI-TEST", "26", "02", "0001")
              if os.path.exists(pdf_path):
                  print(f"[PASS] PDF generated at {pdf_path}")
              else:
                  print("[FAIL] PDF generation failed")
                  sys.exit(1)

              # 4. Mock Printing Logic
              print("Testing Print Command Construction...")
              with patch('subprocess.run') as mock_run:
                  ps = PrintService()
                  import shutil
                  # Workaround for dev mode check in services.py
                  shutil.copy(sumatra_path, "SumatraPDF.exe")
                  
                  ps.print_file(pdf_path, printer_name="DummyPrinter")
                  
                  args = mock_run.call_args[0][0]
                  if "-print-to" in args and "DummyPrinter" in args and "-print-settings" in args:
                      print("[PASS] Print command construction verified")
                  else:
                      print(f"[FAIL] Invalid print command: {args}")
                      sys.exit(1)
              
              print("--- CI Verification Passed! ---")

          if __name__ == '__main__':
              run_ci_test()
          "@
          $testCode | Out-File -FilePath ci_verify.py -Encoding utf8
          python ci_verify.py

      - name: Build EXE (Folder Mode)
        working-directory: ./print-server
        run: |
          pyinstaller --onedir --name BradyAutoLabelServer `
            --collect-submodules reportlab `
            --add-binary "${{ github.workspace }}\sumatra\SumatraPDF.exe;bin/sumatra" `
            app.py



      - name: Create Zip Bundle
        working-directory: ./print-server/dist
        run: |
          Compress-Archive -Path BradyAutoLabelServer -DestinationPath BradyAutoLabelServer-Windows.zip

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BradyAutoLabelServer-Windows
          path: ./print-server/dist/BradyAutoLabelServer-Windows.zip

  create-release:
    needs: [build-windows]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: BradyAutoLabelServer-Windows
          path: ./artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Brady Auto Label Release v${{ github.run_number }}
          body: |
            Automated build for the Brady Auto Label Date System.
            
            ## Downloads
            
            | File | Description |
            |------|-------------|
            | **BradyAutoLabelServer-Windows.zip** | ðŸªŸ **Download This** - Extract and run `BradyAutoLabelServer.exe` inside. No Python required. |
            
            ### How to run:
            1. Download and Extract the ZIP.
            2. Open the folder `BradyAutoLabelServer`.
            3. Double-click **`BradyAutoLabelServer.exe`**.
            4. Keep the window open to allow the frontend to communicate with your printers.
          files: |
            ./artifacts/*.zip
          draft: false
          prerelease: false
